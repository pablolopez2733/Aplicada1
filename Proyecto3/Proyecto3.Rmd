---
title:  'Proyecto 3'
author:
- Fernando Stein Vallarta 165455
- Pablo López Landeros 178863
- Manuel García Garduño 162136
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```



**Objetivo**: El objetivo de este proyecto es estudiar y analizar los niveles de violencia y criminalidad presentes en México. Esto se hará a través de estimadores y conceptos vistos en clase y con la base de datos de la **Encuesta Nacional de Victimización y Percepción sobre Seguridad Pública (ENVIPE) 2019**. En particular, nos centraremos en los delitos de robo, secuestro y homicidio. A pesar de que haremos un análisis nacional, dedicaremos buena parte del análisis a los datos de la CDMX por ser nuestro lugar de residencia.   

## Introducción   

### ENVIPE   
La Encuesta Nacional de Victimización y Percepción sobre Seguridad Pública (ENVIPE) del INEGI es una fuente de datos muy valiosa para los expertos en seguridad pública. Esta encuesta forma parte de los proyectos impulsados por el Subsistema Nacional de Información de Gobierno, Seguridad Pública e Impartición de Justicia (SNIGSPIJ), y está coordinado por el Instituto Nacional de Estadística y Geografía (INEGI). 

* Objetivo de la encuesta:  El INEGI enlista los siguientes rubros como los objetivos de la ENVIPE:
    1. Medir la victimización del hogar y la victimización personal
    2. Estimar el número de víctimas
    3. Estimar el número de delitos ocurridos. 
    4. Estimar la "cifra negra de los delitos y sus causas.
    5. Medir la percepción actual de los habitantes del país sobre la seguridad en el lugar donde viven y donde realizan sus actividades cotidianas. 
    6. Medir el grado de confianza en las instituciones de seguridad pública y la percepción sobre su desempeño.
    7. Identificar y medir los cambios en actividades y hábitos de las personas por temor al delito.
    8. Estimar los costos de la delicuencia a las personas y hogares.
    9. Estimar las repercusiones del delito sobre las víctimas.
    10. Identificar y medir actitudes y experiencias de las víctimas con las instituciones de seguridad pública y de procuración de justicia.

* Metodología de la encuesta: 
    * Población objetivo: La encuesta está dirigida a la población de 18 años cumplidos o más, que residen permanentemente en viviendas particulares dentro del territorio nacional.
    * Cobertura geográfica: La encuesta fue diseñada para dar resultados a los siguientes niveles de segregación:   
    Nacional:
        1. Urbano
        2. Rural
    Entidad federativa   
    CDMX (4 regiones):
            1. Norte
            2. Sur
            3. Oriente
            4. Poniente 
   
    
* Diseño estadístico:     

   
   

|  	|  	|
|-	|-	|
| Periodo de referencia de la información 	| Enero-diciembre de 2018 para victimización<br>Marzo- abril de 2019 para percepción sobre la seguridad <br>pública y desempeño de las autoridades. 	|
| Selección de la muestra 	| Probabilístico: trietápico, estratificado y <br>por conglomerados. 	|
| Unidades de observación 	| Las viviendas seleccionadas, los hogares, <br>los residentes del hogar y la persona <br>seleccionada en el hogar.  	|
| Población objeto del estudio 	| Población de 18 años y más. 	|
| Tamaño de muestra nacional 	| 102,043 viviendas 	|
| Periodo de levantamiento 	| 1 de marzo al 30 de abril de 2019 	|
| Cobertura geográfica 	| A nivel nacional, Nacional urbano, Nacional rural, <br>Entidad Federativa y Áreas Metropolitanas de interés.  	|


**Nota:** Toda esta información fue extraída directamente de la documentación que provee el INEGI como parte de la encuesta. 

* Muestreo   
La encuesta se realizó bajo un modelo **trietápico** en donde la primera etapa se seleccionó una unidad primaria de muestreo. Es decir, una zona geográfica. La segunda etapa fue por vivienda y la tercera fue por personas que habitaban en dicha vivienda.    



## Análisis
Importamos librerías y leemos la base de datos desde un repositorio en Github.:

```{r,tidy=TRUE, message=FALSE, warning=FALSE}
#Paquetes requeridos
library(tidyverse) 
library(cowplot)
library(kableExtra)
library(knitr) 
library(lubridate)
library(dplyr) 
library(moments) 
library(readr)
library(rgdal)
library(broom)
library(scales)
library(lemon)
library(ggplot2)
library(survey)
knit_print.data.frame <- lemon_print

#Lectura de Datos y Diccionario

df <-  read_csv("https://raw.githubusercontent.com/pablolopez2733/Aplicada1/master/Bases%20de%20Datos/conjunto_de_datos_envipe2019_csv/conjunto_de_datos_TPer_Vic2_ENVIPE_2019/conjunto_de_datos/conjunto_de_datos_TPer_Vic2_ENVIPE_2019.csv")


diccionario  <-  read_csv("https://github.com/pablolopez2733/Aplicada1/raw/master/Bases%20de%20Datos/conjunto_de_datos_envipe2019_csv/conjunto_de_datos_TPer_Vic2_ENVIPE_2019/diccionario_de_datos/diccionario_de_datos_TPer_Vic2_ENVIPE_2019.csv", 
    locale = locale(encoding = "WINDOWS-1252"))


```

Diccionario:

```{r}
knitr::kable(diccionario, format="markdown")
```




## Limpieza de datos

```{r,tidy=TRUE, message=FALSE, warning=FALSE}

df<-  df %>% mutate(sufrio.delitos = if_else(AP6_2== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(robo.coche = if_else(AP6_4_01== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(robo.casa = if_else(AP6_4_04== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(secuestro = if_else(AP6_9== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(desaparicion = if_else(AP6_15_1== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(homicidio = if_else(AP6_19== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(asalto = if_else(AP7_3_05== "1\r", 1, 0, missing = 0))
df<-  df %>% mutate(num.asaltos = AP7_4_05)
df<-  df %>% mutate(Estado = NOM_ENT)
df<-  df %>% mutate(Estrato = ESTRATO)


df <- df %>% select(ID_PER,UPM,SEXO,EDAD,FAC_HOG,sufrio.delitos,robo.coche,robo.casa,secuestro,desaparicion,homicidio,asalto,EST_DIS,num.asaltos,Estado,Estrato)
df$FAC_HOG <- as.numeric(df$FAC_HOG)
diseño  <- svydesign(id = ~ID_PER, strata = ~Estrato, weights = ~FAC_HOG,
                     PSU = ~UPM, data = df, nest = TRUE) 

```

 **Validación de la $n$**:    
 
El INEGI sugiere la siguiente expresión para poder determinar el tamaño de la muestra:
$$n = \frac{(Z^2(1-p)DEFF)}{(r^2 p (1-t))}  $$

 Donde:   
 
 * Z es el valor de la norma,
 * DEFF es el cociente de la varianza del diseño utilizado entre la varianza obtenida considerando un MAS 
 * t es la tasa de no respuesta
 * r es el error relativo
 * p es la proporción muestreada
 
El INEGI sugiere los siguientes parámetros:   

* t = .75, 
* p = .011, 
* r = .07635, 
* DEFF = 0.07635
* I.C. de 90% ($\alpha = .1$)



```{r,tidy=TRUE, message=FALSE, warning=FALSE}

#Tamaño de la muestra

alp<-.1
z<-qnorm(1-alp/2)
p<-.011
q<-1-p
e<-.07635
DEFF<-2.078
t<-.15

A<- z^2 * q* DEFF
B<- e^2*p*(1-t)
n<- A/B

#Sin embargo, solamente tenemos que considerar el 
#25.33% de los cuestionarios contestados de forma correcta
#con victimización como parte de nuestra muestra

n.vic<-n*.2533

```

## Gráficas   

Veamos la distribución de hombres y mujeres que sufrieron algún delito, dentro de la muestra:

```{r,tidy=TRUE, message=FALSE, warning=FALSE}



df<- df %>% mutate(Sexo = ifelse(SEXO== "1\r", "HOMBRE", "MUJER"))

hombres.delito <- df %>% 
  filter(Sexo == "HOMBRE" & sufrio.delitos == 1) %>%
  count()
mujeres.delito <- df %>% 
  filter(Sexo == "MUJER" & sufrio.delitos == 1) %>% 
  count()

#Hagamos un df para el barplot
df_1 <- as.data.frame(rbind(hombres.delito,mujeres.delito))
df_1 <- cbind(df_1,c("Hombres","Mujeres"))
names(df_1)[1] <- "Conteo_de_delitos"
names(df_1)[2] <- "Sexo"


ggplot(df_1,aes(x=Sexo,y=Conteo_de_delitos,fill=Sexo))+
  geom_bar (stat="identity", width=0.7)+
  theme_minimal() +
  labs(
  title = "Conteo de víctimas de delitos por sexo durante el 2018 ",
  x = "Sexo",
  y = "Cantidad de delitos"
  )

```
Desafortunadamente, son más mujeres las que son víctimas de delitos. 

* Víctimas de delitos por edad
```{r}
delitos.edad <- df %>% 
  filter(sufrio.delitos == 1) %>%
  group_by(EDAD) %>% 
  count()

#Borramos los que no especificaron edad:
df_bar <- delitos.edad[-c(81), ]


p <- ggplot(df_bar)+
      geom_col(aes(x = EDAD, y = n, fill = EDAD),show.legend = FALSE) +
      ggtitle("Edades de las víctimas de delito") +
      labs(
      x = "Edades",
      y = "Total de delitos"
      )+
      theme(axis.text.x=element_text(angle=45, hjust=1))+
      scale_x_discrete(breaks=c("18\r","28\r", "38\r","48\r",
                                "58\r","68\r","78\r","88\r","97\r"),
        labels=c("18","28", "38","48", "58","68","78","88","97"))
p + theme_minimal()

#Veamos cuantas personas decidieron no especificar su edad
no.especificada <- delitos.edad %>% 
  filter(EDAD == "98\r")

paste0("",no.especificada["n"]," Personas decidieron no especificar su edad.") 

```

Parece ser que la población que más en riesgo parece estar de ser víctima de algún tipo de delito son los adultos jóvenes de entre 30 y 48 años.  Grafiquemos ahora la densidad de robos por edad.



* Cantidad de robos a casa por estado.
```{r tidy=TRUE, message=FALSE, warning=FALSE}
robos.casa <- df %>% 
  filter(homicidio == 1) %>%
  group_by(Estado) %>% 
  count()


p2 <- ggplot(robos.casa)+
      geom_col(aes(x = Estado, y = n, fill = Estado),show.legend = FALSE) +
      ggtitle("Cantidad de homicidios por Estado durante 2018.") +
      theme_minimal()+
      labs(
      x = "Estados",
      y = "Homicidios"
      )+
      theme(axis.text.x=element_text(angle=90, hjust=1,vjust = 0))
p2

```
Parece ser que el Norte del país es altamente inseguro ya que Estados como Chihuahua, Sinaloa, Tamaulipas y Colima presentan conteos altos de homicidios. Sin embargo es en Guerrero donde más homicidios se registran.

* Homicidios vs Asaltos
A continuación presentaremos una visualización muy útil para evaluar riesgo de asalto y homicidio. 

```{r tidy=TRUE, message=FALSE, warning=FALSE}
homicidios.estado <- df %>% 
  filter(homicidio == 1) %>%
  group_by(Estado) %>% 
  count()

asaltos.estado <- df %>% 
  filter(asalto == 1) %>%
  group_by(Estado) %>% 
  count()

names(asaltos.estado)[2] <- "Asaltos"
names(homicidios.estado)[2] <- "Homicidios"

df_scat <- merge(asaltos.estado, homicidios.estado,
                 by = "Estado", incomparables = NA)

#graficamos
scat <- ggplot(df_scat, aes(x=Asaltos, y=Homicidios)) + 
  geom_point(aes(color=Estado), size=3.5,show.legend = FALSE)+
  geom_text(label=df_scat$Estado,vjust=1.5,hjust=.5,colour="black",size=3)+
  ggtitle("Cantidad de homicidios y asaltos por estado")+
  xlim(25, 400)+
  labs(
    caption = "Se quitó la ciudad de México por ser un outlier en 'Asaltos'",
    x = "Asaltos",
    y = "Homicidios"
  )+
  geom_hline(yintercept = mean(df_scat$Homicidios),color = "red",
             linetype = "dashed", alpha=0.5)+
  geom_vline(xintercept = mean(df_scat$Asaltos),color = "red",
             linetype = "dashed", alpha=0.5)

scat+theme_bw()

```
Esta visualización es explicativa porque divide el plano en 4 secciones. La primera sería la esquina inferior izquierda. Podríamos llamarle la "zona segura". Todos los estados en esta zona tienen asaltos y homicidios por debajo del promedio del país. Vemos entonces que bajo este criterio, Aguascalientes, Zacatecas y Nayarit parecen ser los estados menos problemáticos. El recuadro superior izquierdo es zona de riesgo por homicidio (ya que su número de homicidios está por arriba del promedio) pero no por asalto.  La esquina inferior derecha son zonas con alto riesgo de asalto pero poco número de homicidios. La zona superior derecha la denominaría la "zona de alto riesgo". En esta los homicidios y asaltos ambos están por arriba del promedio. Puebla y Morelos parecen ser los únicos dos estados en esta zona. 


## Estimadores

* Media   
Interesa estimar la cantidad total de vehículos robados durante 2018.
```{r}
total.robosv.2018 <- svytotal(~robo.coche, diseño)
total.robosv.2018

```


## Referencias:   


* Salazar, C. F. S. (2019). ENVIPE. Consultado el 23 de julio de 2020, en http://bdsocial.inmujeres.gob.mx/index.php/envipe-290   
* I. (24 de septiembre de 2019). INEGI. Consultado el 23 de julio de 2020, en https://www.inegi.org.mx/app/biblioteca/ficha.html?upc=702825191184
